name: Deploy to Production

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-docker:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to production
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd /opt/streamgate
            git pull origin main
            docker-compose pull
            docker-compose up -d
          EOF

  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Deploy with Helm
        run: |
          helm repo add streamgate https://charts.example.com
          helm repo update
          helm upgrade --install streamgate streamgate/streamgate \
            --namespace production \
            --values deploy/helm/values.yaml \
            --set image.tag=${{ github.ref_name }}
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/streamgate-api-gateway -n production --timeout=5m
          kubectl rollout status deployment/streamgate-auth -n production --timeout=5m
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test --image=curlimages/curl:latest -n production --rm -i --restart=Never -- \
            curl -f http://streamgate-api-gateway:8080/api/v1/health

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-docker, deploy-kubernetes]
    if: always()
    steps:
      - name: Send email notification
        env:
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          REPOSITORY: ${{ github.repository }}
          REF_NAME: ${{ github.ref_name }}
          JOB_STATUS: ${{ job.status }}
          DOCKER_RESULT: ${{ needs.deploy-docker.result }}
          KUBERNETES_RESULT: ${{ needs.deploy-kubernetes.result }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ -n "$EMAIL_USERNAME" ] && [ -n "$EMAIL_PASSWORD" ] && [ -n "$NOTIFICATION_EMAIL" ]; then
            echo "Sending email notification..."
            echo "Subject: StreamGate Deployment - $REF_NAME"
            echo "To: $NOTIFICATION_EMAIL"
            echo "Body:"
            echo "Deployment Status Report"
            echo ""
            echo "Repository: $REPOSITORY"
            echo "Version: $REF_NAME"
            echo "Status: $JOB_STATUS"
            echo "Docker Deployment: $DOCKER_RESULT"
            echo "Kubernetes Deployment: $KUBERNETES_RESULT"
            echo ""
            echo "Commit: $SHA"
            echo "Author: $ACTOR"
            echo ""
            echo "View details: $SERVER_URL/$REPOSITORY/actions/runs/$RUN_ID"
          else
            echo "Email credentials not configured, skipping email notification"
          fi
      
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPOSITORY: ${{ github.repository }}
          REF_NAME: ${{ github.ref_name }}
          JOB_STATUS: ${{ job.status }}
          DOCKER_RESULT: ${{ needs.deploy-docker.result }}
          KUBERNETES_RESULT: ${{ needs.deploy-kubernetes.result }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            echo "Sending Discord notification..."
            echo "Discord webhook: $DISCORD_WEBHOOK"
            echo "Repository: $REPOSITORY"
            echo "Status: $JOB_STATUS"
            echo "Docker: $DOCKER_RESULT"
            echo "Kubernetes: $KUBERNETES_RESULT"
            echo "Author: $ACTOR"
          else
            echo "Discord webhook not configured, skipping Discord notification"
          fi
      
      - name: Send Telegram notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REF_NAME: ${{ github.ref_name }}
          JOB_STATUS: ${{ job.status }}
          DOCKER_RESULT: ${{ needs.deploy-docker.result }}
          KUBERNETES_RESULT: ${{ needs.deploy-kubernetes.result }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "Sending Telegram notification..."
            echo "ðŸš€ StreamGate Deployment"
            echo ""
            echo "Version: $REF_NAME"
            echo "Status: $JOB_STATUS"
            echo "Docker: $DOCKER_RESULT"
            echo "Kubernetes: $KUBERNETES_RESULT"
            echo ""
            echo "Author: $ACTOR"
            echo "Commit: $SHA"
          else
            echo "Telegram credentials not configured, skipping Telegram notification"
          fi
      
      - name: Create GitHub issue on failure
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed: ${context.ref}`,
              body: `## Deployment Failure Report
              
              **Version:** ${context.refName}
              **Status:** ${context.job.status}
              **Docker Deployment:** ${context.payload.inputs['deploy-docker'].result}
              **Kubernetes Deployment:** ${context.payload.inputs['deploy-kubernetes'].result}
              
              **Commit:** ${context.sha}
              **Author:** ${context.actor}
              
              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please investigate the deployment logs and fix the issue.`,
              labels: ['deployment', 'bug']
            })
