name: Deploy to Production

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-docker:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to production
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd /opt/streamgate
            git pull origin main
            docker-compose pull
            docker-compose up -d
          EOF

  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Deploy with Helm
        run: |
          helm repo add streamgate https://charts.example.com
          helm repo update
          helm upgrade --install streamgate streamgate/streamgate \
            --namespace production \
            --values deploy/helm/values.yaml \
            --set image.tag=${{ github.ref_name }}
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/streamgate-api-gateway -n production --timeout=5m
          kubectl rollout status deployment/streamgate-auth -n production --timeout=5m
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test --image=curlimages/curl:latest -n production --rm -i --restart=Never -- \
            curl -f http://streamgate-api-gateway:8080/api/v1/health

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-docker, deploy-kubernetes]
    if: always()
    steps:
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        if: vars.EMAIL_USERNAME != ''
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "StreamGate Deployment - ${{ github.ref_name }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: StreamGate CI/CD
          body: |
            Deployment Status Report
            
            Repository: ${{ github.repository }}
            Version: ${{ github.ref_name }}
            Status: ${{ job.status }}
            Docker Deployment: ${{ needs.deploy-docker.result }}
            Kubernetes Deployment: ${{ needs.deploy-kubernetes.result }}
            
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        if: vars.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          status: ${{ job.status }}
          title: "Deployment: ${{ github.ref_name }}"
          description: |
            Repository: ${{ github.repository }}
            Status: ${{ job.status }}
            Docker: ${{ needs.deploy-docker.result }}
            Kubernetes: ${{ needs.deploy-kubernetes.result }}
            Author: ${{ github.actor }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
      
      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        if: vars.TELEGRAM_TOKEN != ''
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ðŸš€ StreamGate Deployment
            
            Version: ${{ github.ref_name }}
            Status: ${{ job.status }}
            Docker: ${{ needs.deploy-docker.result }}
            Kubernetes: ${{ needs.deploy-kubernetes.result }}
            
            Author: ${{ github.actor }}
            Commit: ${{ github.sha }}
      
      - name: Create GitHub issue on failure
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed: ${context.ref}`,
              body: `## Deployment Failure Report
              
              **Version:** ${context.refName}
              **Status:** ${context.job.status}
              **Docker Deployment:** ${context.payload.inputs['deploy-docker'].result}
              **Kubernetes Deployment:** ${context.payload.inputs['deploy-kubernetes'].result}
              
              **Commit:** ${context.sha}
              **Author:** ${context.actor}
              
              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please investigate the deployment logs and fix the issue.`,
              labels: ['deployment', 'bug']
            })
