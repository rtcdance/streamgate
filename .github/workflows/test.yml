name: Comprehensive Test Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

env:
  GO_VERSION: '1.24.0'
  GOPROXY: 'https://goproxy.io,direct'

jobs:
  unit-tests:
    name: Unit Tests - ${{ matrix.test-path }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test-path:
          - test-unit-analytics
          - test-unit-debug
          - test-unit-middleware
          - test-unit-models
          - test-unit-security
          - test-unit-service
          - test-unit-storage
          - test-unit-web3
          - test-pkg
          - test-cmd
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy" && exit 1)
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Set test path
        id: set-path
        run: |
          case "${{ matrix.test-path }}" in
            test-unit-analytics) echo "path=./test/unit/analytics/..." >> $GITHUB_OUTPUT ;;
            test-unit-debug) echo "path=./test/unit/debug/..." >> $GITHUB_OUTPUT ;;
            test-unit-middleware) echo "path=./test/unit/middleware/..." >> $GITHUB_OUTPUT ;;
            test-unit-models) echo "path=./test/unit/models/..." >> $GITHUB_OUTPUT ;;
            test-unit-security) echo "path=./test/unit/security/..." >> $GITHUB_OUTPUT ;;
            test-unit-service) echo "path=./test/unit/service/..." >> $GITHUB_OUTPUT ;;
            test-unit-storage) echo "path=./test/unit/storage/..." >> $GITHUB_OUTPUT ;;
            test-unit-web3) echo "path=./test/unit/web3/..." >> $GITHUB_OUTPUT ;;
            test-pkg) echo "path=./pkg/..." >> $GITHUB_OUTPUT ;;
            test-cmd) echo "path=./cmd/..." >> $GITHUB_OUTPUT ;;
          esac
      
      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ${{ steps.set-path.outputs.path }}
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit-${{ matrix.test-path }}
          path: coverage.out
          if-no-files-found: ignore

  integration-tests:
    name: Integration Tests - ${{ matrix.test-path }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test-path:
          - test-integration-analytics
          - test-integration-api
          - test-integration-auth
          - test-integration-content
          - test-integration-dashboard
          - test-integration-debug
          - test-integration-middleware
          - test-integration-ml
          - test-integration-models
          - test-integration-monitoring
          - test-integration-optimization
          - test-integration-scaling
          - test-integration-security
          - test-integration-service
          - test-integration-storage
          - test-integration-streaming
          - test-integration-transcoding
          - test-integration-upload
          - test-integration-web3
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: streamgate
          POSTGRES_DB: streamgate
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy" && exit 1)
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Setup database
        env:
          PGPASSWORD: streamgate
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql -h localhost -U streamgate -d streamgate < migrations/001_init_schema.sql
          psql -h localhost -U streamgate -d streamgate < migrations/002_add_content_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/003_add_user_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/004_add_nft_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/005_add_transaction_table.sql
      
      - name: Set test path
        id: set-path
        run: |
          case "${{ matrix.test-path }}" in
            test-integration-analytics) echo "path=./test/integration/analytics/..." >> $GITHUB_OUTPUT ;;
            test-integration-api) echo "path=./test/integration/api/..." >> $GITHUB_OUTPUT ;;
            test-integration-auth) echo "path=./test/integration/auth/..." >> $GITHUB_OUTPUT ;;
            test-integration-content) echo "path=./test/integration/content/..." >> $GITHUB_OUTPUT ;;
            test-integration-dashboard) echo "path=./test/integration/dashboard/..." >> $GITHUB_OUTPUT ;;
            test-integration-debug) echo "path=./test/integration/debug/..." >> $GITHUB_OUTPUT ;;
            test-integration-middleware) echo "path=./test/integration/middleware/..." >> $GITHUB_OUTPUT ;;
            test-integration-ml) echo "path=./test/integration/ml/..." >> $GITHUB_OUTPUT ;;
            test-integration-models) echo "path=./test/integration/models/..." >> $GITHUB_OUTPUT ;;
            test-integration-monitoring) echo "path=./test/integration/monitoring/..." >> $GITHUB_OUTPUT ;;
            test-integration-optimization) echo "path=./test/integration/optimization/..." >> $GITHUB_OUTPUT ;;
            test-integration-scaling) echo "path=./test/integration/scaling/..." >> $GITHUB_OUTPUT ;;
            test-integration-security) echo "path=./test/integration/security/..." >> $GITHUB_OUTPUT ;;
            test-integration-service) echo "path=./test/integration/service/..." >> $GITHUB_OUTPUT ;;
            test-integration-storage) echo "path=./test/integration/storage/..." >> $GITHUB_OUTPUT ;;
            test-integration-streaming) echo "path=./test/integration/streaming/..." >> $GITHUB_OUTPUT ;;
            test-integration-transcoding) echo "path=./test/integration/transcoding/..." >> $GITHUB_OUTPUT ;;
            test-integration-upload) echo "path=./test/integration/upload/..." >> $GITHUB_OUTPUT ;;
            test-integration-web3) echo "path=./test/integration/web3/..." >> $GITHUB_OUTPUT ;;
          esac
      
      - name: Run integration tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: streamgate
          DB_PASSWORD: streamgate
          DB_NAME: streamgate
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: go test -v -race -coverprofile=coverage.out ${{ steps.set-path.outputs.path }}
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration-${{ matrix.test-path }}
          path: coverage.out
          if-no-files-found: ignore

  e2e-tests:
    name: E2E Tests - ${{ matrix.test-file }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        test-file:
          - analytics_e2e_test.go
          - api_gateway_test.go
          - auth_flow_test.go
          - blue_green_deployment_test.go
          - canary_deployment_test.go
          - content_management_test.go
          - core_functionality_test.go
          - dashboard_e2e_test.go
          - debug_e2e_test.go
          - hpa_scaling_test.go
          - middleware_flow_test.go
          - ml_e2e_test.go
          - models_test.go
          - monitoring_flow_test.go
          - nft_verification_test.go
          - optimization_e2e_test.go
          - plugin_integration_test.go
          - resource_optimization_e2e_test.go
          - scaling_e2e_test.go
          - security_e2e_test.go
          - streaming_flow_test.go
          - transcoding_flow_test.go
          - upload_flow_test.go
          - util_functions_test.go
          - web3_integration_test.go
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: streamgate
          POSTGRES_DB: streamgate
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not tidy" && exit 1)
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Setup database
        env:
          PGPASSWORD: streamgate
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql -h localhost -U streamgate -d streamgate < migrations/001_init_schema.sql
          psql -h localhost -U streamgate -d streamgate < migrations/002_add_content_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/003_add_user_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/004_add_nft_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/005_add_transaction_table.sql
      
      - name: Run E2E test - ${{ matrix.test-file }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: streamgate
          DB_PASSWORD: streamgate
          DB_NAME: streamgate
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: go test -v -race -coverprofile=coverage.out -run TestFile ./test/e2e/${{ matrix.test-file }}
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-e2e-${{ matrix.test-file }}
          path: coverage.out
          if-no-files-found: ignore
          retention-days: 1

  benchmark-tests:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Run benchmarks
        run: go test -bench=. -benchmem -run=^$ ./test/benchmark/... | tee benchmark-results.txt
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt

  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: streamgate
          POSTGRES_DB: streamgate
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Setup database
        env:
          PGPASSWORD: streamgate
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql -h localhost -U streamgate -d streamgate < migrations/001_init_schema.sql
          psql -h localhost -U streamgate -d streamgate < migrations/002_add_content_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/003_add_user_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/004_add_nft_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/005_add_transaction_table.sql
      
      - name: Run load tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: streamgate
          DB_PASSWORD: streamgate
          DB_NAME: streamgate
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: go test -v -timeout=30m ./test/load/...
      
      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: test/load/

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: streamgate
          POSTGRES_DB: streamgate
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Setup database
        env:
          PGPASSWORD: streamgate
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql -h localhost -U streamgate -d streamgate < migrations/001_init_schema.sql
          psql -h localhost -U streamgate -d streamgate < migrations/002_add_content_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/003_add_user_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/004_add_nft_table.sql
          psql -h localhost -U streamgate -d streamgate < migrations/005_add_transaction_table.sql
      
      - name: Run security tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: streamgate
          DB_PASSWORD: streamgate
          DB_NAME: streamgate
        run: go test -v ./test/security/...
      
      - name: Upload security test results
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: test/security/

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, benchmark-tests, load-tests, security-tests]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate test report
        run: |
          echo "# Test Summary Report" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Results" >> test-summary.md
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test-summary.md
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> test-summary.md
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> test-summary.md
          echo "- Benchmark Tests: ${{ needs.benchmark-tests.result }}" >> test-summary.md
          echo "- Load Tests: ${{ needs.load-tests.result }}" >> test-summary.md
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> test-summary.md
      
      - name: Upload test summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md
